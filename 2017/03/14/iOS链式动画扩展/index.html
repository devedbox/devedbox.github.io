<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Animation,ChainAnimation,CoreAnimation,iOS," />





  <link rel="alternate" href="/atom.xml" title="devedbox" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="SummaryAXAnimationChain是一个链式动画库，可以用来轻松的创建基于CAAnimation的链式动画。链的组合方式有两种，一种是组合，另一种则是链接，通过以上两种方式创建的动画，既可以同时进行，也可以按时间先后进行，可以使用较少的代码创建出丰富复杂的动画效果：
简单使用:
_transitionView.spring.centerBy(CGPointMake(0, 100)).e">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS链式动画扩展">
<meta property="og:url" content="devedbox.com/2017/03/14/iOS链式动画扩展/index.html">
<meta property="og:site_name" content="devedbox">
<meta property="og:description" content="SummaryAXAnimationChain是一个链式动画库，可以用来轻松的创建基于CAAnimation的链式动画。链的组合方式有两种，一种是组合，另一种则是链接，通过以上两种方式创建的动画，既可以同时进行，也可以按时间先后进行，可以使用较少的代码创建出丰富复杂的动画效果：
简单使用:
_transitionView.spring.centerBy(CGPointMake(0, 100)).e">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/d2297bd2gw1fbnl029rgzj21kw09hq6f.jpg">
<meta property="og:image" content="https://img.shields.io/badge/build-passing-52c435.svg">
<meta property="og:image" content="https://img.shields.io/cocoapods/v/AXAnimationChain.svg?style=flat">
<meta property="og:image" content="https://img.shields.io/dub/l/vibe-d.svg">
<meta property="og:image" content="https://img.shields.io/cocoapods/p/AXAnimationChain.svg?style=flat">
<meta property="og:image" content="https://img.shields.io/badge/language-Objective--C/Swift-orange.svg">
<meta property="og:image" content="https://img.shields.io/badge/swift3.x-available-orange.svg">
<meta property="og:image" content="https://img.shields.io/badge/weibo-@devedbox-blue.svg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/d2297bd2gw1fbnm3goqqbg20uk0h0n0j.gif">
<meta property="og:image" content="http://ww2.sinaimg.cn/large/d2297bd2jw1fbnm5kyythg20uk0h0dhx.gif">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/d2297bd2gw1fbmrilba19j21c610047c.jpg">
<meta property="og:image" content="http://ww2.sinaimg.cn/large/d2297bd2jw1fbnm7hgqesg20uk0h0wle.gif">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/d2297bd2gw1fbnm9807j7g20uk0h01e0.gif">
<meta property="og:updated_time" content="2017-12-14T15:25:24.790Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS链式动画扩展">
<meta name="twitter:description" content="SummaryAXAnimationChain是一个链式动画库，可以用来轻松的创建基于CAAnimation的链式动画。链的组合方式有两种，一种是组合，另一种则是链接，通过以上两种方式创建的动画，既可以同时进行，也可以按时间先后进行，可以使用较少的代码创建出丰富复杂的动画效果：
简单使用:
_transitionView.spring.centerBy(CGPointMake(0, 100)).e">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> iOS链式动画扩展 | devedbox </title>
</head>

<!-- custom analytics part create by xiamo -->
<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("dGgPPFSrVcACvpPPwfL3UwTs-gzGzoHsz", "QewucF4h9rLTKPzLpeshgEer");</script>
<script>
function showTime(Counter) {
	var query = new AV.Query(Counter);
	$(".leancloud_visitors").each(function() {
		var url = $(this).attr("id").trim();
		query.equalTo("url", url);
		query.find({
			success: function(results) {
				if (results.length == 0) {
					var content = '0 ' + $(document.getElementById(url)).text();
					$(document.getElementById(url)).text(content);
					return;
				}
				for (var i = 0; i < results.length; i++) {
					var object = results[i];
					var content = object.get('time') + ' ' + $(document.getElementById(url)).text();
					$(document.getElementById(url)).text(content);
				}
			},
			error: function(object, error) {
				console.log("Error: " + error.code + " " + error.message);
			}
		});

	});
}

function addCount(Counter) {
	var Counter = AV.Object.extend("Counter");
	url = $(".leancloud_visitors").attr('id').trim();
	title = $(".leancloud_visitors").attr('data-flag-title').trim();
	var query = new AV.Query(Counter);
	query.equalTo("url", url);
	query.find({
		success: function(results) {
			if (results.length > 0) {
				var counter = results[0];
				counter.fetchWhenSave(true);
				counter.increment("time");
				counter.save(null, {
					success: function(counter) {
						var content =  counter.get('time') + ' ' + $(document.getElementById(url)).text();
						$(document.getElementById(url)).text(content);
					},
					error: function(counter, error) {
						console.log('Failed to save Visitor num, with error message: ' + error.message);
					}
				});
			} else {
				var newcounter = new Counter();
				newcounter.set("title", title);
				newcounter.set("url", url);
				newcounter.set("time", 1);
				newcounter.save(null, {
					success: function(newcounter) {
					    console.log("newcounter.get('time')="+newcounter.get('time'));
						var content = newcounter.get('time') + ' ' + $(document.getElementById(url)).text();
						$(document.getElementById(url)).text(content);
					},
					error: function(newcounter, error) {
						console.log('Failed to create');
					}
				});
			}
		},
		error: function(error) {
			console.log('Error:' + error.code + " " + error.message);
		}
	});
}
$(function() {
	var Counter = AV.Object.extend("Counter");
	if ($('.leancloud_visitors').length == 1) {
		addCount(Counter);
	} else if ($('.post-title-link').length > 1) {
		showTime(Counter);
	}
}); 
</script>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?32614a826ac53952df6db42620ff904e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">devedbox</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">devedbox'blog | iOS | Objective-C | Swift | Cocoa</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
      
        <li class="menu-item menu-item-search">
          <a href="#" class="st-search-show-outputs">
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'Yw4Mn9e_Adahe2DHcnrS','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                iOS链式动画扩展
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-03-14T23:23:33+08:00" content="2017-03-14">
              2017-03-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/教程/" itemprop="url" rel="index">
                    <span itemprop="name">教程</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/教程/项目介绍/" itemprop="url" rel="index">
                    <span itemprop="name">项目介绍</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/03/14/iOS链式动画扩展/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/14/iOS链式动画扩展/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/03/14/iOS链式动画扩展/" class="leancloud_visitors" data-flag-title="iOS链式动画扩展">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="http://ww1.sinaimg.cn/large/d2297bd2gw1fbnl029rgzj21kw09hq6f.jpg" alt="Logo"></p>
<p><img src="https://img.shields.io/badge/build-passing-52c435.svg" alt="Build"><img src="https://img.shields.io/cocoapods/v/AXAnimationChain.svg?style=flat" alt="Version"><img src="https://img.shields.io/dub/l/vibe-d.svg" alt="License"><img src="https://img.shields.io/cocoapods/p/AXAnimationChain.svg?style=flat" alt="Platform"><img src="https://img.shields.io/badge/language-Objective--C/Swift-orange.svg" alt="language"><img src="https://img.shields.io/badge/swift3.x-available-orange.svg" alt="language"><img src="https://img.shields.io/badge/weibo-@devedbox-blue.svg" alt="weibo"></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p><a href="https://github.com/devedbox/AXAnimationChain" target="_blank" rel="external">AXAnimationChain</a>是一个<strong><code>链式动画库</code></strong>，可以用来轻松的创建基于<code>CAAnimation</code>的链式动画。<strong>链</strong>的组合方式有两种，一种是<strong>组合</strong>，另一种则是<strong>链接</strong>，通过以上两种方式创建的动画，既可以同时进行，也可以按时间先后进行，可以使用较少的代码创建出丰富复杂的动画效果：</p>
<p><strong>简单使用</strong>:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">_transitionView.spring.centerBy(CGPointMake(0, 100)).easeOut.spring.sizeBy(CGSizeMake(100, 100)).spring.cornerRadiusBy(4).animate();</span><br></pre></td></tr></table></figure>
<p><img src="http://ww1.sinaimg.cn/large/d2297bd2gw1fbnm3goqqbg20uk0h0n0j.gif" alt="SimpleSample"></p>
<p><strong>高级使用</strong>:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">_transitionView.chainAnimator.basic.target(self).complete(@selector(complete:)).property(@&#34;position&#34;).toValue([NSValue valueWithCGPoint:CGPointMake(100, self.view.center.y)]).easeInBack.duration(0.5).combineSpring.target(self).complete(@selector(complete:)).property(@&#34;bounds&#34;).toValue([NSValue valueWithCGRect:CGRectMake(0, 0, 100, 100)]).duration(0.5).repeatCount(5).autoreverses.combineSpring.target(self).complete(@selector(complete:)).property(@&#34;transform.rotation&#34;).toValue(@(M_PI_4)).duration(0.5).repeatCount(3).beginTime(1.0).autoreverses.nextToBasic.property(@&#34;position&#34;).toValue([NSValue valueWithCGPoint:self.view.center]).duration(0.5).combineSpring.property(@&#34;bounds&#34;).toValue([NSValue valueWithCGRect:CGRectMake(0, 0, 100, 100)]).duration(0.8).nextToBasic.property(@&#34;transform.rotation&#34;).toValue(@(M_PI_4)).duration(1.0).completeWithBlock(nil).animate();</span><br></pre></td></tr></table></figure>
<p>看起来比较冗余，但是细读会发现，其实就只有<strong>一行代码</strong>.</p>
<p><img src="http://ww2.sinaimg.cn/large/d2297bd2jw1fbnm5kyythg20uk0h0dhx.gif" alt="sample"></p>
<p><strong>链接</strong>和<strong>组合</strong>在协议<code>AXAnimatorChainDelegate</code>中进行定义，分别是：<code>nextTo:</code>和<code>combineWith:</code>，在使用的过程中应当予以区分. </p>
<p><code>AXAnimationChain</code>基于<code>CoreAnimation</code>定义了几种<code>Animator</code>，<code>AXChainAnimator</code>是基类，预定义了一系列<code>Animate</code>操作，可以<strong>链接</strong>、<strong>组合</strong>并且控制动画完成的<strong>回调</strong>：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">AXChainAnimator&#10;  --AXBasicChainAnimator     ==CABasicAnimation&#10;    --AXSpringChainAnimator  ==CASpringAnimation&#10;  --AXKeyframeChainAnimator  ==CAKeyframeAnimation&#10;  --AXTransitionChainAnimator==CATransitionAnimation</span><br></pre></td></tr></table></figure>
<h3 id="Next-To"><a href="#Next-To" class="headerlink" title="Next-To"></a>Next-To</h3><p>通过链接的方式处理两个<code>animator</code>，<strong>被链接</strong>的<code>animator</code>将会在前者动画(包含<em><code>组合</code></em>的动画)完成之后进行动画, 大概的示例如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">[former nextTo:nexter];</span><br></pre></td></tr></table></figure>
<p><code>Next-To</code>方法的原型如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">- (instancetype)nextTo:(id&#60;AXAnimatorChainDelegate&#62;)animator;</span><br></pre></td></tr></table></figure>
<p>当向<code>former aniamtor</code>发送<code>nextTo:</code>消息之后，返回的是<code>nexter animator</code>作为下次<strong>链接</strong>或者<strong>组合</strong>操作的对象，因此<code>AXAnimationChain</code>定义了几种常用的操作：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">/// &#38142;&#25509;&#21040;Basic&#21160;&#30011;&#24182;&#19988;&#36820;&#22238;&#38142;&#25509;&#30340;Basic&#21160;&#30011;.&#10;- (AXBasicChainAnimator *)nextToBasic;&#10;/// &#38142;&#25509;&#21040;Spring&#21160;&#30011;&#24182;&#19988;&#25918;&#22238;&#38142;&#25509;&#30340;Spring&#21160;&#30011;.&#10;- (AXSpringChainAnimator *)nextToSpring;&#10;/// &#38142;&#25509;&#21040;Keyframe&#21160;&#30011;&#24182;&#19988;&#25918;&#22238;&#38142;&#25509;&#30340;Keyframe&#21160;&#30011;.&#10;- (AXKeyframeChainAnimator *)nextToKeyframe;&#10;/// &#38142;&#25509;&#21040;Transition&#21160;&#30011;&#24182;&#19988;&#36820;&#22238;&#38142;&#25509;&#30340;Transition&#21160;&#30011;.&#10;- (AXTransitionChainAnimator *)nextToTransition;</span><br></pre></td></tr></table></figure>
<p>在发送消息之后分别返回对应类型的<strong>可操作对象</strong>.</p>
<h3 id="Combine-With"><a href="#Combine-With" class="headerlink" title="Combine-With"></a>Combine-With</h3><p>通过组合的方式处理两个<code>animator</code>，被组合的<code>animator</code>将会与前者动画同时进行，完成的时间以时间最长的为准, 示例如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">[former combineWith:combiner];</span><br></pre></td></tr></table></figure>
<p><code>Combine-With</code>方法原型如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">- (instancetype)combineWith:(nonnull AXChainAnimator *)animator;</span><br></pre></td></tr></table></figure>
<p>当向<code>former animator</code>发送<code>combineWith:</code>消息之后，返回的是<code>combiner animator</code>作为下次<strong>链接</strong>或者<strong>组合</strong>操作的对象，在<code>AXAnimationChain</code>中，默认一下几种组合方式：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">/// &#32452;&#21512;&#21040;Basic&#21160;&#30011;&#24182;&#19988;&#36820;&#22238;&#32452;&#21512;&#30340;Basic&#21160;&#30011;.&#10;- (AXBasicChainAnimator *)combineBasic;&#10;/// &#32452;&#21512;&#21040;Spring&#21160;&#30011;&#24182;&#19988;&#25918;&#22238;&#32452;&#21512;&#30340;Spring&#21160;&#30011;.&#10;- (AXSpringChainAnimator *)combineSpring;&#10;/// &#32452;&#21512;&#21040;Keyframe&#21160;&#30011;&#24182;&#19988;&#25918;&#22238;&#32452;&#21512;&#30340;Keyframe&#21160;&#30011;.&#10;- (AXKeyframeChainAnimator *)combineKeyframe;&#10;/// &#32452;&#21512;&#21040;Transition&#21160;&#30011;&#24182;&#19988;&#36820;&#22238;&#32452;&#21512;&#30340;Transition&#21160;&#30011;.&#10;- (AXTransitionChainAnimator *)combineTransition;</span><br></pre></td></tr></table></figure>
<p>同样的，在向某一操作对象<code>animator</code>发送以上消息之后，将会分别返回对应类型的<strong>可操作对象</strong>.</p>
<h3 id="Relationship"><a href="#Relationship" class="headerlink" title="Relationship"></a>Relationship</h3><p>在<code>AXAnimationChain</code>中，关系的管理采用的是二叉树的理论. 某一个<code>animator</code>对应的类结构中，包含了指向<strong>父节点</strong>的<code>superAnimator</code>用于表示<code>父animator</code>, 表示此<code>animator</code>为<code>superAnimator</code>所链接的<code>animator</code>, 此时，<code>superAnimator</code>的<code>childAnimator</code>即指向此<code>animator</code>作为一个<strong>闭环链</strong>将两者的关系锁定起来; 同样的，某一个<code>animator</code>还拥有一个指向<strong>兄弟节点</strong>的<code>NSArray&lt;AXChainAnimator *&gt;</code>结构:<code>combinedAnimators</code>用于管理所组合的<code>animators</code>，并且，被组合的<code>animator</code>的父节点<code>superAnimator</code>则指向当前<code>animator</code>. </p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">- (void)start &#123;&#10;    NSAssert(_animatedView, @&#34;Animation chain cannot be created because animated view is null.&#34;);&#10;    AXChainAnimator *superAnimator = _superAnimator;&#10;    AXChainAnimator *superSuperAnimator = _superAnimator;&#10;    while (superAnimator) &#123;&#10;        superAnimator = superAnimator.superAnimator;&#10;        if (superAnimator) &#123;&#10;            superSuperAnimator = superAnimator;&#10;        &#125;&#10;    &#125;&#10;    if (superSuperAnimator) &#123;&#10;        [superSuperAnimator start];&#10;    &#125; else &#123;&#10;        [self _beginAnimating];&#10;        if (!_childAnimator) [self _clear];&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p><code>AXAnimatioChain</code>就是通过这样的关系把所有<strong>链接</strong>和<strong>组合</strong>的<code>animator</code>管理起来的，在完成关系的链接或组合之后，需要向最后一个<code>animator</code>发送<code>-start</code>消息动画才能正常进行. <code>animator</code>在接收到<code>-start</code>消息之后，会逐级遍历<code>superAnimator</code>直至<code>superAnimator.superAnimator==nil</code>, 此时获取到<code>superSuperAnimator</code>, 从<code>superSuperAnimator</code>自祖先往下逐级进行动画，<strong>组合</strong>的动画会<strong>同时</strong>进行，<strong>链接</strong>的动画则按<strong>顺序</strong>进行.</p>
<h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><ul>
<li>轻量级解决方案</li>
<li>基于CoreAnimation的封装，安全、高效！</li>
<li>一行代码搞定复杂的动画管理，提高代码维护效</li>
</ul>
<h4 id="TimingControl"><a href="#TimingControl" class="headerlink" title="TimingControl"></a>TimingControl</h4><p>时间曲线，时间曲线用于描述动画随时间进行的速度，<code>AXAnimationChain</code>除了包含系统默认的时间曲线之外，还提供了如下的曲线以呈现更漂亮的动画：</p>
<p><img src="http://ww1.sinaimg.cn/large/d2297bd2gw1fbmrilba19j21c610047c.jpg" alt="http://ww1.sinaimg.cn/large/d2297bd2gw1fbmrilba19j21c610047c.jpg"></p>
<h4 id="AXSpringAnimation"><a href="#AXSpringAnimation" class="headerlink" title="AXSpringAnimation"></a>AXSpringAnimation</h4><p><code>CoreAnimation</code>自<code>iOS2.0</code>就为iOS平台提供了核心动画的支持，但是在iOS9.0之前，一直没有<code>Spring</code>动画，要使用<code>Spring</code>动画要么使用第三方动画库，要么使用系统提供的方法:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">+ (void)animateWithDuration:(NSTimeInterval)duration delay:(NSTimeInterval)delay usingSpringWithDamping:(CGFloat)dampingRatio initialSpringVelocity:(CGFloat)velocity options:(UIViewAnimationOptions)options animations:(void (^)(void))animations completion:(void (^ __nullable)(BOOL finished))completion NS_AVAILABLE_IOS(7_0);</span><br></pre></td></tr></table></figure>
<p>但是系统提供的这个方法也是<code>iOS7.0</code>以后才能使用了，并且在控制上并非那么容易.</p>
<p> <code>AXSpringAnimation</code>是基于<strong>阻尼震动</strong>运动模型的<code>Spring</code>动画类，能够完美与<code>CASpringAnimation</code>相通用：</p>
<p><img src="http://ww2.sinaimg.cn/large/d2297bd2jw1fbnm7hgqesg20uk0h0wle.gif" alt="SpringSample"></p>
<p>动画中，左边正方形使用的是<code>CASpringAnimation</code>类，右边的则使用的是<code>AXSpringAnimation</code>，两者的动画曲线是一致的.</p>
<p>同样地，<code>AXSpringAnimation</code>的API和<code>CASpringAnimation</code>也是一致的：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">@interface AXSpringAnimation : CAKeyframeAnimation&#10;/* The mass of the object attached to the end of the spring. Must be greater&#10; than 0. Defaults to one. */&#10;&#10;@property(assign, nonatomic) CGFloat mass;&#10;&#10;/* The spring stiffness coefficient. Must be greater than 0.&#10; * Defaults to 100. */&#10;&#10;@property(assign, nonatomic) CGFloat stiffness;&#10;&#10;/* The damping coefficient. Must be greater than or equal to 0.&#10; * Defaults to 10. */&#10;&#10;@property(assign, nonatomic) CGFloat damping;&#10;&#10;/* The initial velocity of the object attached to the spring. Defaults&#10; * to zero, which represents an unmoving object. Negative values&#10; * represent the object moving away from the spring attachment point,&#10; * positive values represent the object moving towards the spring&#10; * attachment point. */&#10;&#10;@property(assign, nonatomic) CGFloat initialVelocity;&#10;&#10;/* Returns the estimated duration required for the spring system to be&#10; * considered at rest. The duration is evaluated for the current animation&#10; * parameters. */&#10;&#10;@property(readonly, nonatomic) CFTimeInterval settlingDuration;&#10;&#10;/* The objects defining the property values being interpolated between.&#10; * All are optional, and no more than two should be non-nil. The object&#10; * type should match the type of the property being animated (using the&#10; * standard rules described in CALayer.h). The supported modes of&#10; * animation are:&#10; *&#10; * - both `fromValue&#39; and `toValue&#39; non-nil. Interpolates between&#10; * `fromValue&#39; and `toValue&#39;.&#10; *&#10; * - `fromValue&#39; and `byValue&#39; non-nil. Interpolates between&#10; * `fromValue&#39; and `fromValue&#39; plus `byValue&#39;.&#10; *&#10; * - `byValue&#39; and `toValue&#39; non-nil. Interpolates between `toValue&#39;&#10; * minus `byValue&#39; and `toValue&#39;. */&#10;&#10;@property(nullable, strong, nonatomic) id fromValue;&#10;@property(nullable, strong, nonatomic) id toValue;&#10;@property(nullable, strong, nonatomic) id byValue;&#10;@end</span><br></pre></td></tr></table></figure>
<h4 id="Convertable"><a href="#Convertable" class="headerlink" title="Convertable"></a>Convertable</h4><p><code>AXAnimationChain</code>框架还提供了将<code>CABasicAnimation</code>无缝转换为<code>CAKeyframeAnimation</code>的功能：</p>
<p><img src="http://ww1.sinaimg.cn/large/d2297bd2gw1fbnm9807j7g20uk0h01e0.gif" alt="ConvertSample"></p>
<p>动画中，左边是<code>CABasicAnimation</code>，右边是<code>CAKeyframeAnimation</code>，两者对应的动画曲线是一致的.</p>
<p>要使用动画转换，请参考：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#import &#60;QuartzCore/QuartzCore.h&#62;&#10;#import &#60;UIKit/UIKit.h&#62;&#10;#import &#34;CAMediaTimingFunction+Extends.h&#34;&#10;&#10;@interface CAAnimation (Convertable)&#10;@end&#10;&#10;@interface CAKeyframeAnimation (Convertable)&#10;+ (instancetype)animationWithBasic:(CABasicAnimation *)basicAnimation;&#10;+ (instancetype)animationWithBasic:(CABasicAnimation *)basicAnimation usingValuesFunction:(double (^)(double t, double b, double c, double d))valuesFunction;&#10;@end</span><br></pre></td></tr></table></figure>
<h2 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h2><p><code>AXAnimationChain</code> 对系统版本支持到<code>iOS8.0</code>，需要使用到的框架：</p>
<ul>
<li>Foundation.framework</li>
</ul>
<ul>
<li>UIKit.framework</li>
<li>QuartzCore.framework</li>
</ul>
<p>使用的时候最好使用最新版Xcode.</p>
<h2 id="Adding-AXAimationChain-To-Your-Project"><a href="#Adding-AXAimationChain-To-Your-Project" class="headerlink" title="Adding AXAimationChain To Your Project"></a>Adding <code>AXAimationChain</code> To Your Project</h2><h3 id="CocoaPods"><a href="#CocoaPods" class="headerlink" title="CocoaPods"></a>CocoaPods</h3><p><a href="[http://cocoapods.org](http://cocoapods.org">CocoaPods</a>) is the recommended way to add AXAimationChain to your project.</p>
<ol>
<li>Add a pod entry for AXAimationChain to your Podfile <code>pod &#39;AXAimationChain&#39;, &#39;~&gt; 0.2.3&#39;</code></li>
<li>Install the pod(s) by running <code>pod install</code>.</li>
<li>Include AXAimationChain wherever you need it with <code>#import &quot;AXAimationChain.h&quot;</code>.</li>
<li>若需要单独使用<code>AXSpringAnimation</code>或者<code>Convertable</code>以及<code>TimingControl</code>等特性的话，只需要将podfile里边<code>AXAnimationChain</code>替换为<code>AXAnimationChain/CoreAnimation</code>即可，即：<code>pod &#39;AXAimationChain/CoreAnimation&#39;, &#39;~&gt; 0.2.3&#39;</code>.</li>
<li>若要使用<code>Swift</code>作为变成语言，请使用Swift版的依赖包：<code>pod &#39;AXAimationChain-Swift&#39;, &#39;~&gt; 0.2.3&#39;</code></li>
</ol>
<h3 id="Source-files"><a href="#Source-files" class="headerlink" title="Source files"></a>Source files</h3><p>Alternatively you can directly add all the source files to your project.</p>
<ol>
<li>Download the <a href="[https://github.com/devedbox/AXAimationChain/archive/master.zip](https://github.com/devedbox/AXAimationChain/archive/master.zip">latest code version</a>) or add the repository as a git submodule to your git-tracked project. </li>
<li>Open your project in Xcode, then drag and drop the source group onto your project (use the “Product Navigator view”). Make sure to select Copy items when asked if you extracted the code archive outside of your project. </li>
<li>Include AXAnimationChain wherever you need it with <code>#import &quot;AXAimationChain.h&quot;</code>.</li>
<li>如单独使用<code>AXSpringAnimation</code>或者<code>Convertable</code>以及<code>TimingControl</code>等特性，只需要导入<code>#import &quot;AXCoreAnimation.h&quot;</code>即可.</li>
</ol>
<h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><p>This code is distributed under the terms and conditions of the <a href="LICENSE">MIT license</a>. </p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>请参考示例工程代码以及API.</p>
<h2 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h2><p>此项目在开展的时候比较庞大，基础的核心类已经构建好了，基本目标已经达成，但是还有很多需要完善的地方，后边会逐步完善并发布Release版本.</p>
<h2 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h2><p>转载需注明出处：<code>http://devedbox.com/AXAnimationChain/</code></p>

      
    </div>

    <div>
      
        
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Animation/" rel="tag">#Animation</a>
          
            <a href="/tags/ChainAnimation/" rel="tag">#ChainAnimation</a>
          
            <a href="/tags/CoreAnimation/" rel="tag">#CoreAnimation</a>
          
            <a href="/tags/iOS/" rel="tag">#iOS</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/08/02/AXWebViewController/" rel="next" title="AXWebViewController">
                <i class="fa fa-chevron-left"></i> AXWebViewController
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/14/Swift-Style-Guide/" rel="prev" title="Swift代码规范与实践">
                Swift代码规范与实践 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/03/14/iOS链式动画扩展/"
           data-title="iOS链式动画扩展" data-url="devedbox.com/2017/03/14/iOS链式动画扩展/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="devedbox" />
          <p class="site-author-name" itemprop="name">devedbox</p>
          <p class="site-description motion-element" itemprop="description">Seeking for the grace of coding.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">13</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/devedbox" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/AAxXxA" target="_blank">
                  
                    <i class="fa fa-weibo"></i> Weibo
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number">1.</span> <span class="nav-text">Summary</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Next-To"><span class="nav-number">1.1.</span> <span class="nav-text">Next-To</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Combine-With"><span class="nav-number">1.2.</span> <span class="nav-text">Combine-With</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Relationship"><span class="nav-number">1.3.</span> <span class="nav-text">Relationship</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Features"><span class="nav-number">2.</span> <span class="nav-text">Features</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TimingControl"><span class="nav-number">2.0.1.</span> <span class="nav-text">TimingControl</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AXSpringAnimation"><span class="nav-number">2.0.2.</span> <span class="nav-text">AXSpringAnimation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Convertable"><span class="nav-number">2.0.3.</span> <span class="nav-text">Convertable</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Requirements"><span class="nav-number">3.</span> <span class="nav-text">Requirements</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Adding-AXAimationChain-To-Your-Project"><span class="nav-number">4.</span> <span class="nav-text">Adding AXAimationChain To Your Project</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CocoaPods"><span class="nav-number">4.1.</span> <span class="nav-text">CocoaPods</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Source-files"><span class="nav-number">4.2.</span> <span class="nav-text">Source files</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#License"><span class="nav-number">5.</span> <span class="nav-text">License</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用"><span class="nav-number">6.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#不足"><span class="nav-number">7.</span> <span class="nav-text">不足</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#声明"><span class="nav-number">8.</span> <span class="nav-text">声明</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">devedbox</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=0.5.0"></script>



  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.scheme !== 'Pisces' && (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always')) {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"devedbox"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  

  
  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("dGgPPFSrVcACvpPPwfL3UwTs-gzGzoHsz", "QewucF4h9rLTKPzLpeshgEer");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>




</body>
</html>
